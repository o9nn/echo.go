name: Autonomous Agent CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
      
      - name: Run gofmt
        run: |
          echo "Checking code formatting..."
          if [ -n "$(gofmt -l .)" ]; then
            echo "The following files are not formatted:"
            gofmt -l .
            exit 1
          fi
      
      - name: Run go vet
        run: |
          echo "Running go vet..."
          go vet ./...
      
      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2
      
      - name: Run golangci-lint
        run: |
          echo "Running golangci-lint..."
          $(go env GOPATH)/bin/golangci-lint run --timeout=5m
        continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
      
      - name: Run Gosec Security Scanner
        run: |
          echo "Running security scan..."
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          $(go env GOPATH)/bin/gosec -fmt=json -out=gosec-report.json ./...
        continue-on-error: true
      
      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: gosec-report.json
          retention-days: 7

  dependency-check:
    name: Dependency Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
      
      - name: Check for vulnerabilities
        run: |
          echo "Checking dependencies for known vulnerabilities..."
          go install golang.org/x/vuln/cmd/govulncheck@latest
          $(go env GOPATH)/bin/govulncheck ./...
        continue-on-error: true
      
      - name: List outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          go list -u -m all

  build-matrix:
    name: Build on Multiple Platforms
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ['1.21']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
      
      - name: Build echoself
        run: go build -v -o echoself${{ matrix.os == 'windows-latest' && '.exe' || '' }} cmd/echoself/main.go
      
      - name: Verify binary
        if: matrix.os != 'windows-latest'
        run: |
          ls -lh echoself
          file echoself
      
      - name: Verify binary (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          dir echoself.exe
