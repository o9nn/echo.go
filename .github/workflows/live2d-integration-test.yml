name: Live2D Integration Tests

on:
  push:
    paths:
      - 'Source/Live2DCubism/**'
      - '.github/workflows/live2d-integration-test.yml'
    branches: [ main, develop ]
  pull_request:
    paths:
      - 'Source/Live2DCubism/**'
      - '.github/workflows/live2d-integration-test.yml'
    branches: [ main, develop ]

env:
  LIVE2D_SDK_VERSION: 4.2.04
  UNREAL_ENGINE_VERSION: 5.3

jobs:
  live2d-validation:
    name: Live2D SDK Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate Live2D SDK integration
        run: |
          echo "Validating Live2D Cubism SDK integration..."
          
          # Check for Live2D header files
          if [ ! -d "Source/Live2DCubism" ]; then
            echo "ERROR: Live2D integration directory not found"
            exit 1
          fi
          
          # Check for required headers
          required_headers=(
            "Live2DCubismAvatarComponent.h"
            "ExpressionSynthesizer.h"
            "PhysicsDeformer.h"
          )
          
          for header in "${required_headers[@]}"; do
            if ! find Source/Live2DCubism -name "$header" | grep -q .; then
              echo "WARNING: Required header $header not found"
            fi
          done
          
          # Check for Live2D SDK linkage
          if grep -r "Live2D" CMakeLists.txt Source/ --include="*.cpp" --include="*.h" | grep -q "find_package\|FetchContent"; then
            echo "✓ Live2D SDK properly configured"
          else
            echo "WARNING: Live2D SDK configuration not found"
          fi
      
      - name: Check Live2D parameter mappings
        run: |
          echo "Validating Live2D parameter mappings..."
          
          # Check for parameter mapping structures
          if grep -r "Live2DParameterMapping\|ParameterMapping" Source/Live2DCubism --include="*.h" | grep -q "struct\|class"; then
            echo "✓ Parameter mapping structures found"
          else
            echo "WARNING: Parameter mapping structures not found"
          fi
          
          # Validate parameter names
          if grep -r "happiness\|surprise\|sadness\|anger\|fear" Source/Live2DCubism --include="*.h" | grep -q .; then
            echo "✓ Emotional parameter mappings found"
          else
            echo "WARNING: Emotional parameter mappings not found"
          fi

  expression-synthesis-test:
    name: Expression Synthesis Tests
    runs-on: ubuntu-latest
    needs: live2d-validation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up C++
        uses: egor-tensin/setup-gcc@v1
        with:
          version: 13
          platform: x64
      
      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: 3.27
      
      - name: Build expression synthesis tests
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_LIVE2D_TESTS=ON
          cmake --build build --target live2d_expression_tests --parallel
        continue-on-error: true
      
      - name: Run expression synthesis tests
        run: |
          if [ -f build/tests/live2d_expression_tests ]; then
            ./build/tests/live2d_expression_tests
          else
            echo "Expression synthesis tests not built"
          fi
        continue-on-error: true
      
      - name: Validate expression blending
        run: |
          echo "Testing expression blending algorithms..."
          
          # Check for blending implementation
          if grep -r "BlendExpressions\|InterpolateExpressions" Source/Live2DCubism --include="*.cpp" | grep -q "void\|float"; then
            echo "✓ Expression blending implementation found"
          else
            echo "WARNING: Expression blending implementation not found"
          fi

  animation-rendering-test:
    name: Animation Rendering Tests
    runs-on: ubuntu-latest
    needs: live2d-validation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up C++
        uses: egor-tensin/setup-gcc@v1
        with:
          version: 13
          platform: x64
      
      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: 3.27
      
      - name: Build animation rendering tests
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_LIVE2D_TESTS=ON
          cmake --build build --target live2d_animation_tests --parallel
        continue-on-error: true
      
      - name: Run animation rendering tests
        run: |
          if [ -f build/tests/live2d_animation_tests ]; then
            ./build/tests/live2d_animation_tests
          else
            echo "Animation rendering tests not built"
          fi
        continue-on-error: true
      
      - name: Validate animation blending
        run: |
          echo "Testing animation blending..."
          
          # Check for animation blending
          if grep -r "AnimationBlender\|BlendAnimation" Source/Avatar --include="*.h" | grep -q "class\|struct"; then
            echo "✓ Animation blending system found"
          else
            echo "WARNING: Animation blending system not found"
          fi

  physics-simulation-test:
    name: Physics Simulation Tests
    runs-on: ubuntu-latest
    needs: live2d-validation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up C++
        uses: egor-tensin/setup-gcc@v1
        with:
          version: 13
          platform: x64
      
      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: 3.27
      
      - name: Build physics tests
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_PHYSICS_TESTS=ON
          cmake --build build --target physics_simulation_tests --parallel
        continue-on-error: true
      
      - name: Run physics simulation tests
        run: |
          if [ -f build/tests/physics_simulation_tests ]; then
            ./build/tests/physics_simulation_tests
          else
            echo "Physics simulation tests not built"
          fi
        continue-on-error: true
      
      - name: Validate physics deformer
        run: |
          echo "Validating physics deformation system..."
          
          # Check for physics implementation
          if grep -r "PhysicsDeformer\|PhysicsSimulation" Source/Live2DCubism --include="*.h" | grep -q "class"; then
            echo "✓ Physics deformer system found"
          else
            echo "WARNING: Physics deformer system not found"
          fi

  performance-benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [expression-synthesis-test, animation-rendering-test, physics-simulation-test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up C++
        uses: egor-tensin/setup-gcc@v1
        with:
          version: 13
          platform: x64
      
      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: 3.27
      
      - name: Build benchmarks
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_BENCHMARKS=ON
          cmake --build build --target live2d_benchmarks --parallel
        continue-on-error: true
      
      - name: Run performance benchmarks
        run: |
          if [ -f build/benchmarks/live2d_benchmarks ]; then
            ./build/benchmarks/live2d_benchmarks --benchmark_out=benchmark_results.json --benchmark_out_format=json
          else
            echo "Benchmarks not built"
          fi
        continue-on-error: true
      
      - name: Analyze benchmark results
        run: |
          echo "Performance Benchmark Analysis"
          echo "==============================="
          
          # Target metrics
          echo "Target: Avatar render time < 16.67ms (60 FPS)"
          echo "Target: Expression synthesis < 10ms"
          echo "Target: Physics simulation < 5ms per frame"
          
          if [ -f benchmark_results.json ]; then
            echo "Benchmark results saved"
            cat benchmark_results.json | head -50
          fi
        continue-on-error: true
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: live2d-benchmarks
          path: benchmark_results.json
          retention-days: 30

  integration-summary:
    name: Live2D Integration Summary
    runs-on: ubuntu-latest
    needs: [live2d-validation, expression-synthesis-test, animation-rendering-test, physics-simulation-test, performance-benchmark]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "Live2D Integration Test Summary"
          echo "==============================="
          echo "SDK Validation: ${{ needs.live2d-validation.result }}"
          echo "Expression Synthesis: ${{ needs.expression-synthesis-test.result }}"
          echo "Animation Rendering: ${{ needs.animation-rendering-test.result }}"
          echo "Physics Simulation: ${{ needs.physics-simulation-test.result }}"
          echo "Performance Benchmarks: ${{ needs.performance-benchmark.result }}"
          
          if [ "${{ needs.live2d-validation.result }}" = "failure" ] || \
             [ "${{ needs.expression-synthesis-test.result }}" = "failure" ] || \
             [ "${{ needs.animation-rendering-test.result }}" = "failure" ] || \
             [ "${{ needs.physics-simulation-test.result }}" = "failure" ]; then
            echo "❌ Live2D Integration Tests FAILED"
            exit 1
          else
            echo "✅ Live2D Integration Tests PASSED"
          fi
